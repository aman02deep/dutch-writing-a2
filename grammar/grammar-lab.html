<!DOCTYPE html>
<html lang="nl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="copyright" content="¬© 2026 Dutch A2 Practice App. All rights reserved.">
    <meta name="description" content="Interactive Dutch A2 practice exercises for the Inburgeringsexamen. Master grammar, vocabulary, KNM, and writing with AI-powered feedback.">
    <meta name="keywords" content="Dutch A2, Inburgeringsexamen, NT2, learn Dutch, Dutch grammar, Dutch vocabulary, KNM practice">
    <meta property="og:title" content="Grammar Lab - Dutch A2">
    <meta property="og:description" content="Interactive Dutch A2 practice exercises for the Inburgeringsexamen. Master grammar, vocabulary, KNM, and writing with AI-powered feedback.">
    <meta property="og:type" content="website">
    <title>Grammar Lab - Dutch A2</title>
    <link rel="stylesheet" href="../css/common/style.css">
    <link rel="stylesheet" href="../css/grammar/grammar-lab.css">
    <link rel="stylesheet" href="../css/common/navigation.css">
    <link rel="stylesheet" href="../css/common/settings.css">
    <link rel="stylesheet" href="../css/common/breadcrumb.css">
    <link rel="stylesheet" href="../css/vocabulary/vocabulary.css">
    <link rel="stylesheet" href="../css/grammar/sentence-structure.css">
</head>

<body>
    <!-- Navigation Header -->
    <nav class="nav-header">
        <div class="nav-container">
            <a href="../index.html" class="nav-home">
                <span class="nav-home-icon">üè†</span>
                <span>Home</span>
            </a>
            <div class="nav-page-title"><a href="../writing/writing.html" class="nav-parent-link">Writing Practice</a> <span class="nav-separator">|</span> üß™ Grammar Lab</div>
        </div>
    </nav>

    <!-- Main Container with Sidebar and Content -->
    <div class="main-area">
        <aside id="nav-sidebar">
            <div class="jump-links">
                <button class="jump-btn btn-e" onclick="jumpTo(0)">üü¢ Start Easy</button>
                <button class="jump-btn btn-m" onclick="jumpTo(30)">üü† Start Medium</button>
                <button class="jump-btn btn-h" onclick="jumpTo(60)">üî¥ Start Hard</button>
            </div>
            <div class="scroll-area">
                <div class="nav-grid" id="nav-grid"></div>
            </div>
        </aside>

        <!-- Content Wrapper -->
        <main class="workspace content-wrapper">
            <div class="top-bar">
                <div class="top-left">
                    <button class="btn-sec" onclick="toggleSidebar()">‚ò∞ List</button>
                    <div id="diff-label" class="difficulty-badge easy">Easy</div>
                    <div id="header-progress" style="font-weight: bold; color: #555;">1 of 100</div>
                </div>
                <!-- Mobile Exercise Selector (hidden on desktop) -->
                <div class="mobile-exercise-selector">
                    <label for="mobile-exercise-select">Ex:</label>
                    <select id="mobile-exercise-select" onchange="jumpTo(parseInt(this.value))">
                        <!-- Options 1-100 will be populated by JavaScript -->
                    </select>
                </div>
                <div class="top-right">
                    <button class="btn-rule-toggle" onclick="toggleRule()">View Rule</button>
                    <button class="btn-sec" onclick="toggleMode()">Mode: <span id="mode-text">Blocks</span></button>
                </div>
            </div>

            <div class="app-content">
                <div class="app-container">
                    <div class="translation" id="translation">Loading...</div>

                    <div id="block-area">
                        <div class="drop-zone" id="answer-zone" onclick="returnToBank(event)"></div>
                        <div class="word-bank" id="word-bank"></div>
                    </div>
                    <input type="text" id="writing-input" placeholder="Typ de Nederlandse zin hier...">

                    <div id="rule-box">
                        <span id="rule-title">Grammar Logic</span>
                        <div id="rule-text"></div>
                        <div class="rule-formula" id="rule-formula"></div>
                        <div class="rule-example" id="rule-example"></div>
                    </div>

                    <div id="feedback"></div>

                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <button class="btn-main" onclick="checkAnswer()">Check Answer</button>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-sec" style="flex:1" onclick="prev()">Previous</button>
                            <button class="btn-sec" style="flex:1" onclick="next()">Next</button>
                        </div>
                    </div>
                </div>
            </div>
    </div>
    </main>

    <script src="../js/grammar/questions-set-1.js"></script>
    <script src="../js/common/ai-service.js"></script>

    <script>

        let currentIdx = 0;
        let results = new Array(100).fill(null);
        let writingMode = false;
        let discoveredVerbs = new Set();

        function toggleSidebar() { document.getElementById('nav-sidebar').classList.toggle('collapsed'); }
        function initNav() {
            const grid = document.getElementById('nav-grid'); grid.innerHTML = "";
            for (let i = 0; i < 100; i++) {
                const item = document.createElement('div');
                item.className = 'nav-item'; item.innerText = i + 1;
                item.id = `nav-${i}`; item.onclick = () => jumpTo(i);
                grid.appendChild(item);
            }
        }
        function jumpTo(idx) { currentIdx = idx; loadQuestion(); }

        function loadQuestion() {
            const q = questions[currentIdx] || questions[0];
            document.getElementById('header-progress').innerText = `${currentIdx + 1} of 100`;
            document.getElementById('translation').innerText = `üá¨üáß ${q.eng}`;

            // Populate Enhanced Rule Box
            document.getElementById('rule-text').innerText = q.logic || "Standard word order applies.";
            document.getElementById('rule-formula').innerText = q.formula || "Subject + Verb + Rest";
            document.getElementById('rule-example').innerText = q.example ? `Example: ${q.example}` : "";
            document.getElementById('rule-box').style.display = 'none';

            document.getElementById('feedback').innerText = "";
            document.getElementById('writing-input').value = "";
            const label = document.getElementById('diff-label');
            label.innerText = q.diff; label.className = `difficulty-badge ${q.diff}`;

            const bank = document.getElementById('word-bank');
            const zone = document.getElementById('answer-zone');
            bank.innerHTML = ""; zone.innerHTML = "";
            [...q.words].sort(() => Math.random() - 0.5).forEach(w => {
                let div = document.createElement('div');
                div.className = 'word'; div.innerText = w;
                div.onclick = () => zone.appendChild(div);
                bank.appendChild(div);
            });
            updateNavStyles();
        }

        function toggleMode() {
            writingMode = !writingMode;
            document.getElementById('mode-text').innerText = writingMode ? "Writing" : "Blocks";
            document.getElementById('block-area').style.display = writingMode ? "none" : "block";
            document.getElementById('writing-input').style.display = writingMode ? "block" : "none";
        }

        async function checkAnswer() {
            const q = questions[currentIdx];
            let userStr = writingMode ? document.getElementById('writing-input').value :
                Array.from(document.getElementById('answer-zone').children).map(c => c.innerText).join(" ");

            const cleanUser = userStr.toLowerCase().replace(/[.,?]/g, "").trim();
            const cleanTarget = q.dut.toLowerCase().replace(/[.,?]/g, "").trim();
            const isExactMatch = cleanUser === cleanTarget;

            const fb = document.getElementById('feedback');
            const ruleBox = document.getElementById('rule-box');

            // 1. Exact Match (Instant Success)
            if (isExactMatch) {
                fb.innerHTML = renderFeedbackCard(
                    '‚úÖ Correct!',
                    'Exact Match',
                    '<strong>Goed gedaan!</strong> Perfecte zin.',
                    'success'
                );
                results[currentIdx] = true;
                if (q.verb) addVerb(q.verb);
                ruleBox.style.display = 'none'; // Hide rule if correct
            }
            // 2. Smart Check (AI Verification for Writing Mode)
            else if (writingMode && userStr.length > 5) {
                // Show analyzing state
                fb.innerHTML = renderFeedbackCard(
                    'ü§ñ AI Analysis',
                    'Checking...',
                    '<span class="loading-dots">Thinking... Verifying flexibility...</span>',
                    'ai'
                );

                // Call Optimized Single-Step AI
                const result = await aiService.smartAnalyze(userStr, q.dut, q.eng);

                if (result.isValid) {
                    fb.innerHTML = renderFeedbackCard(
                        '‚úÖ Smart Check',
                        'Valid Alternative',
                        `<strong>Great job!</strong> Your sentence is grammatically correct and means the same thing.<br>
                        <span style="font-size:0.85em; color:#666;">Original target: "${q.dut}"</span>`,
                        'success'
                    );
                    results[currentIdx] = true;
                    if (q.verb) addVerb(q.verb);
                    ruleBox.style.display = 'none';
                } else {
                    // Pass the already-loaded feedback to showError
                    showError(q, userStr, result.feedback);
                }
            }
            // 3. Wrong Answer
            else {
                showError(q, userStr);
            }
            updateNavStyles();
        }

        async function showError(q, userStr, preloadedFeedback = null) {
            const fb = document.getElementById('feedback');
            const ruleBox = document.getElementById('rule-box');

            results[currentIdx] = false;
            ruleBox.style.display = 'block';
            document.getElementById('rule-title').innerText = "üí° Hint: " + (q.logic || "Check word order!");

            // If in writing mode, get full AI analysis (skip red box)
            if (writingMode && userStr.length > 3) {
                // If we already have feedback from smartAnalyze, show it instantly!
                if (preloadedFeedback) {
                    const formattedAnalysis = preloadedFeedback
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');

                    fb.innerHTML = renderFeedbackCard(
                        'ü§ñ AI Analysis',
                        'Feedback',
                        formattedAnalysis,
                        'ai'
                    );
                }
                else {
                    // Fallback (Rare case: direct call or error)
                    fb.innerHTML = renderFeedbackCard(
                        'ü§ñ AI Analysis',
                        'Analyzing Mistake...',
                        '<span class="loading-dots">Finding corrections and grammar tips...</span>',
                        'ai'
                    );

                    const analysis = await aiService.analyzeSentence(userStr, q.dut, q.eng);

                    const formattedAnalysis = analysis
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');

                    fb.innerHTML = renderFeedbackCard(
                        'ü§ñ AI Analysis',
                        'Feedback',
                        formattedAnalysis,
                        'ai'
                    );
                }
            } else {
                // Standard block mode error (Red Box)
                fb.innerHTML = renderFeedbackCard(
                    '‚ùå Incorrect',
                    'Try Again',
                    "Word order is incorrect.",
                    'error'
                );
            }
        }

        function addVerb(v) {
            if (!discoveredVerbs.has(v[0])) {
                discoveredVerbs.add(v[0]);
                // document.getElementById('verb-list').innerHTML += ... (Fix: verb-list element might be missing in this file?)
            }
        }

        function returnToBank(e) { if (e.target.className === 'word') document.getElementById('word-bank').appendChild(e.target); }
        function toggleRule() { const b = document.getElementById('rule-box'); b.style.display = b.style.display === 'none' ? 'block' : 'none'; }
        function next() { currentIdx = (currentIdx + 1) % 100; loadQuestion(); }
        function prev() { currentIdx = (currentIdx - 1 + 100) % 100; loadQuestion(); }
        function updateNavStyles() {
            for (let i = 0; i < 100; i++) {
                const item = document.getElementById(`nav-${i}`);
                if (!item) continue;
                item.classList.remove('active', 'is-correct', 'is-wrong');
                if (i === currentIdx) item.classList.add('active');
                if (results[i] === true) item.classList.add('is-correct');
                if (results[i] === false) item.classList.add('is-wrong');
            }
        }
        initNav(); loadQuestion();
    </script>

    <!-- Sentence Structure Modal -->
    <div id="sentence-modal" class="modal">
        <div id="sentence-modal-content">
            <div class="sentence-modal-header">
                <h2>üìê Sentence Structure</h2>
                <button class="sentence-close" onclick="closeSentenceStructure()">&times;</button>
            </div>
            <div id="sentence-content"></div>
        </div>
    </div>

    <!-- Floating Sentence Structure Button -->
    <button class="btn-sentence-structure" onclick="openSentenceStructure()" title="Sentence Structure (Ctrl+S)">
        üìê
    </button>

    <script src="../js/common/common.js"></script>
    <script src="../js/vocabulary/vocabulary.js"></script>
    <script src="../js/vocabulary/vocabulary-ui.js"></script>
    <script src="../js/grammar/sentence-structure.js"></script>
    <script src="../js/grammar/sentence-structure-ui.js"></script>
    <script src="../js/common/settings.js"></script>
</body>

</html>